<!DOCTYPE html>
<meta charset="utf-8" />

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>

<!-- Form for user input -->
<form id="percentageForm">
  <label for="percentage"
    >Enter percentage of smaller square compared to the bigger square:</label
  >
  <input
    type="number"
    id="percentage"
    name="percentage"
    min="0"
    max="100"
    step="any"
    required
  />
  <input type="submit" value="Submit" />
</form>

<script>
  // set the dimensions and margins of the graph
  const margin = { top: 10, right: 10, bottom: 10, left: 10 },
    width = 445 - margin.left - margin.right,
    height = 445 - margin.top - margin.bottom;

  let trialNumber = 1;

  // append the svg object to the body of the page
  const svg = d3
    .select("#my_dataviz")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", `translate(${margin.left}, ${margin.top})`);

  // Event listener for form submission
  document
    .getElementById("percentageForm")
    .addEventListener("submit", function (event) {
      event.preventDefault(); // Prevent default form submission

      const percentage = parseFloat(
        document.getElementById("percentage").value
      );
      if (!isNaN(percentage) && trialNumber <= 6) {
        // If a valid number is entered
        alert("trial " + trialNumber + " submitted");
        // Handle submission logic here
        trialNumber++;
        loadTrial(trialNumber);
      } else if (trialNumber > 6) {
        console.log("All trials have been completed.");
      } else {
        alert("Please enter a valid percentage.");
      }
    });

  // Function to load data for a trial
  function loadTrial(trialNumber) {
    if (trialNumber > 6) {
      return;
    }
    d3.csv("/CSV/csv" + trialNumber + ".csv")
      .then(function (data) {
        // stratify the data: reformatting for d3.js
        const root = d3
          .stratify()
          .id(function (d) {
            return d.Section;
          }) // Name of the entity (column name is name in csv)
          .parentId(function (d) {
            return d.Group;
          })(data); // Name of the parent (column name is parent in csv)
        root.sum(function (d) {
          return +d.Number;
        }); // Compute the numeric value for each entity

        // Then d3.treemap computes the position of each element of the hierarchy
        // The coordinates are added to the root object above
        d3.treemap().size([width, height]).padding(4)(root);

        // Generate two unique random indexes
        const randomIndexes = [];
        while (randomIndexes.length < 2) {
          const index = Math.floor(Math.random() * root.leaves().length);
          if (!randomIndexes.includes(index)) {
            randomIndexes.push(index);
          }
        }

        // Store data of the randomly selected rectangles
        const selectedRectangles = root
          .leaves()
          .filter((d, i) => randomIndexes.includes(i));

        // use this information to add rectangles:
        svg
          .selectAll("rect")
          .data(root.leaves())
          .join("rect")
          .attr("x", function (d) {
            return d.x0;
          })
          .attr("y", function (d) {
            return d.y0;
          })
          .attr("width", function (d) {
            return d.x1 - d.x0;
          })
          .attr("height", function (d) {
            return d.y1 - d.y0;
          })
          .style("stroke", "black")
          .style("fill", function (d, i) {
            // Change color for randomly selected data points
            if (randomIndexes.includes(i)) {
              return "red";
            } else {
              return "#69b3a2"; // Default color
            }
          });
      })
      .catch(function (error) {
        //all trials complete
      });
  }

  // Load the first trial
  loadTrial(1);
</script>
